<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ØªØ§ÙƒØ³ÙŠ Ù†ÙˆØ§ÙƒØ´ÙˆØ·</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      overflow: hidden;
      height: 100vh;
      touch-action: pan-y;
      background: #f5f5f5;
    }

    .header {
      background: linear-gradient(90deg, #075e54, #128C7E);
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .menu-toggle {
      background: none; border: none; color: white; font-size: 24px; cursor: pointer;
    }

    .sidebar {
      position: fixed;
      top: 60px;
      right: -300px;
      width: 300px;
      height: calc(100% - 60px);
      background: white;
      box-shadow: -4px 0 15px rgba(0,0,0,0.1);
      z-index: 2000;
      transition: right 0.4s ease;
      padding: 20px;
      overflow-y: auto;
    }
    .sidebar.open { right: 0; }
    .sidebar h3 { color: #075e54; margin-bottom: 20px; }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    .btn {
      background: #075e54;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    .btn:hover { background: #054a43; }
    .btn-outline {
      background: transparent;
      border: 2px solid #075e54;
      color: #075e54;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .section { margin-top: 30px; }
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #075e54;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 2px solid #e0e0e0;
    }
    .driver-list { list-style: none; }
    .driver-item {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      padding: 12px 15px !important;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .driver-item:hover {
      background: #f0f0f0;
      transform: translateX(4px);
    }
    .driver-item.inactive { opacity: 0.6; }
    .driver-item strong { color: #075e54; }

    .unread-badge {
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .driver-item i {
      font-size: 18px;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .driver-item i:hover {
      background: rgba(0,0,0,0.05);
    }

    .map-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5;
    }
    #map { width: 100%; height: 100%; }

    #permissionScreen {
      position: fixed;
      top: 60px; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      z-index: 100;
    }
    #permissionScreen h2 { color: #075e54; margin: 15px 0; font-size: 24px; }
    #permissionScreen p { color: #444; line-height: 1.7; margin: 15px 0; max-width: 380px; }
    .requirement {
      background: #e8f5e9;
      border-right: 4px solid #4caf50;
      padding: 12px;
      margin: 12px 0;
      border-radius: 0 8px 8px 0;
      text-align: right;
    }
    #allowBtn {
      background: #075e54;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 14px 36px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(7, 94, 84, 0.4);
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    #allowBtn:hover:not(:disabled) { background: #054a43; }
    #allowBtn:disabled { opacity: 0.7; }

    .control-btns {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: none;
    }

    .driver-card {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 12px;
      padding: 15px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      z-index: 99;
      display: none;
    }
    .driver-card h4 { color: #075e54; margin-bottom: 8px; }
    .driver-card p { margin: 5px 0; color: #555; }
    .driver-distance { 
      background: #e8f5e9; 
      color: #2e7d32; 
      padding: 5px 10px;
      border-radius: 20px;
      display: inline-block;
      font-weight: bold;
    }

    .overlay {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1999;
      display: none;
    }
    .overlay.active { display: block; }

    /* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
    .alert {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
    }
    .alert-success { 
      background: #e8f5e9; 
      color: #2e7d32; 
      border-right: 3px solid #4caf50;
    }
    .alert-error { 
      background: #ffebee; 
      color: #c62828; 
      border-right: 3px solid #f44336;
    }

    /* âœ… Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø© */
    #registerModal {
      position: fixed;
      top: 60px;
      right: -300px;
      width: 300px;
      height: calc(100% - 60px);
      background: white;
      box-shadow: -4px 0 15px rgba(0,0,0,0.2);
      z-index: 2500;
      transition: right 0.4s ease;
      padding: 20px;
      overflow-y: auto;
    }
    #registerModal.open {
      right: 0;
    }
    .modal-title {
      color: #075e54;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      background: none;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
    }

    /* âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      background: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: #075e54 !important;
      color: white !important;
    }
    .tab-btn:hover:not(.active) {
      background: #d5d5d5 !important;
    }

    /* âœ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
    .driver-only {
      display: none;
    }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .chat-modal {
      position: fixed;
      bottom: -500px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 400px;
      height: 450px;
      background: white;
      border-radius: 15px 15px 0 0;
      box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      transition: bottom 0.3s ease;
    }

    .chat-modal.open {
      bottom: 0;
    }

    .chat-header {
      background: linear-gradient(90deg, #075e54, #128C7E);
      color: white;
      padding: 15px;
      border-radius: 15px 15px 0 0;
      text-align: center;
      position: relative;
    }

    .chat-header h4 {
      margin: 0;
      font-size: 16px;
    }

    .close-chat {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    #chatDriverInfo {
      font-size: 12px;
      margin-top: 5px;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message.sent {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .message-time {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
      text-align: right;
    }

    .chat-input {
      display: flex;
      padding: 15px;
      background: white;
      border-top: 1px solid #e0e0e0;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
    }

    .chat-input input:focus {
      border-color: #128C7E;
    }

    .chat-input button {
      background: #128C7E;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      background: #075e54;
    }

    .chat-input button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Ø²Ø± ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .chat-toggle-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      background: #128C7E;
      color: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .chat-toggle-btn:hover {
      background: #075e54;
      transform: scale(1.05);
    }

    .chat-toggle-btn.has-unread::after {
      content: '';
      position: absolute;
      top: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      background: #ff4444;
      border-radius: 50%;
      border: 2px solid white;
    }

    @media (max-width: 768px) {
      .sidebar, #registerModal {
        width: 300px;
        right: -300px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div></div>
    ğŸš– ØªØ§ÙƒØ³ÙŠ Ù†ÙˆØ§ÙƒØ´ÙˆØ·
    <button class="menu-toggle" id="menuToggle">
      <i class="fas fa-bars"></i>
    </button>
  </header>

  <div class="overlay" id="overlay"></div>

  <aside class="sidebar" id="sidebar">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <div id="authSection">
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="email" placeholder="example@gmail.com">
      </div>
      <div class="form-group">
        <label><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      </div>
      <button class="btn" id="loginBtn">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="btn btn-outline" id="registerBtn">ğŸ“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    </div>

    <div id="driverProfileSection" style="display:none;">
      <div class="alert alert-success" id="welcomeMsg">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="userName"></span>!</div>
      <button class="btn btn-outline" id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

      <div class="section">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
          <input type="text" id="profileName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
        </div>
        <div class="form-group" id="profileIdCardGroup">
          <label><i class="fas fa-id-card"></i> Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© / Ø§Ù„Ø±Ø®ØµØ©</label>
          <input type="text" id="profileIdCard" placeholder="12345678">
        </div>
        <div class="form-group" id="profilePhoneGroup">
          <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input type="tel" id="profilePhone" placeholder="46XXXXXX">
        </div>
        <button class="btn" id="saveProfileBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        <button class="btn" id="startTrackingBtn" style="display:none;">ğŸ“ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
      <ul class="driver-list" id="driverList">
        <li class="driver-item" style="padding:15px; text-align:center; color:#666;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>
      </ul>
    </div>
  </aside>

  <!-- âœ… Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø© -->
  <div id="registerModal">
    <button class="close-modal" id="closeRegisterModal">&times;</button>
    <div class="modal-title">ğŸ“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
    
    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tab-container">
      <button id="tabUser" class="tab-btn active">
        ğŸ‘¤ Ø²Ø¨ÙˆÙ†
      </button>
      <button id="tabDriver" class="tab-btn">
        ğŸš– Ø³Ø§Ø¦Ù‚
      </button>
    </div>

    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© -->
    <div class="form-group">
      <label><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input type="text" id="regName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
    </div>
    
    <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±) -->
    <div class="form-group driver-only" id="regIdCardGroup">
      <label><i class="fas fa-id-card"></i> Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© / Ø§Ù„Ø±Ø®ØµØ©</label>
      <input type="text" id="regIdCard" placeholder="12345678">
    </div>
    <div class="form-group driver-only" id="regPhoneGroup">
      <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
      <input type="tel" id="regPhone" placeholder="46XXXXXX">
    </div>
    
    <div class="form-group">
      <label><i class="fas fa-envelope"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="regEmail" placeholder="example@gmail.com">
    </div>
    <div class="form-group">
      <label><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="regPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    </div>

    <!-- Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div class="terms-checkbox driver-only" id="termsGroup">
      <input type="checkbox" id="termsCheck">
      <label for="termsCheck">
        Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŒ ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ø¹Ø¯Ù… ØªØ¹Ø±ÙŠØ¶ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø£ÙŠ Ø®Ø·Ø± Ø£Ùˆ Ø£Ø°Ù‰ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©.
      </label>
    </div>

    <button class="btn" id="submitRegister">âœ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div id="chatModal" class="chat-modal">
    <div class="chat-header">
      <button class="close-chat" id="closeChat">&times;</button>
      <h4>ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
      <div id="chatDriverInfo"></div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." maxlength="500">
      <button id="sendMessageBtn">ğŸ“¤</button>
    </div>
  </div>

  <!-- Ø²Ø± ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <button class="chat-toggle-btn" id="chatToggleBtn">
    <i class="fas fa-comments"></i>
  </button>

  <div id="permissionScreen">
    <div class="emoji">ğŸ“</div>
    <h2>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨</h2>
    <p>Ù„Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠØŒ ÙŠØ¬Ø¨ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ø¥Ù„ÙŠÙƒ.</p>
    <div class="requirement">âœ… Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</div>
    <div class="requirement">âœ… Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø£Ùˆ Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ù…Ø¹ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø©</div>
    <div class="requirement">âœ… ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª</div>
    <button id="allowBtn">
      <span class="emoji">ğŸ§­</span> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†
    </button>
  </div>

  <main class="map-container" id="mapContainer" style="display:none;">
    <div id="map"></div>
  </main>

  <div class="control-btns" id="controlBtns">
    <button class="btn" id="requestBtn">
      <span class="emoji">ğŸš•</span> Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠ
    </button>
  </div>

  <div class="driver-card" id="driverCard">
    <h4>Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ø¥Ù„ÙŠÙƒ</h4>
    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="driverNameShow">---</span></p>
    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> <span id="driverIdCardShow">---</span></p>
    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="driverPhoneShow">---</span></p>
    <p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> <span class="driver-distance" id="distanceText">--</span></p>
    <p><strong>Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> <span id="etaText">--</span> Ø¯Ù‚Ø§Ø¦Ù‚</p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // âš ï¸ --- âœ… Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ Firebase âœ… ---
    const firebaseConfig = {
      apiKey: "AIzaSyCd72265mC_yNPAXYl-8jXxJgZk-afC7Y4",
      authDomain: "ryada-6773b.firebaseapp.com",
      projectId: "ryada-6773b",
      storageBucket: "ryada-6773b.firebasestorage.app",
      messagingSenderId: "567927086495",
      appId: "1:567927086495:web:1cf92498647022f017b1aa",
      measurementId: "G-F08ZYR9FTH"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
    let map = null;
    let userMarker = null;
    let userLatLng = null;
    let trackingInterval = null;
    let driverMarkers = new Map();
    let currentChatRoom = null;
    let chatUnsubscribe = null;
    let currentDriver = null;
    let isTyping = false;
    let unreadCount = 0;
    let lastRenderTime = 0;

    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function showToast(msg, type = 'success') {
      let div = document.createElement('div');
      div.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => {
        if (div.parentNode) div.remove();
      }, 2500);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function calculateETA(distanceKm) {
      const avgSpeedKmph = 30;
      return Math.ceil((distanceKm / avgSpeedKmph) * 60);
    }

    // âœ… Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
    async function getUnreadCountForDriver(driverUid) {
      const user = auth.currentUser;
      if (!user) return 0;

      const uids = [user.uid, driverUid].sort();
      const roomId = uids.join('_');

      const snapshot = await db.collection('chats')
        .doc(roomId)
        .collection('messages')
        .where('sender', '!=', user.uid)
        .where('read', '==', false)
        .get();

      const now = Date.now();
      const cutoff = 10 * 60 * 1000;
      let unread = 0;

      snapshot.docs.forEach(doc => {
        const msg = doc.data();
        const msgTime = msg.timestamp?.toDate?.()?.getTime?.() || 0;
        if (now - msgTime <= cutoff) {
          unread++;
        }
      });

      return unread;
    }

    // âœ… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    function showAllDrivers() {
      db.collection('drivers')
        .where('role', '==', 'driver')
        .where('isActive', '==', true)
        .get()
        .then(snapshot => {
          const allDrivers = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            if (d.location && d.location.lat) {
              allDrivers.push({ uid: doc.id, ...d });
            }
          });
          renderDriverList(allDrivers);
          showToast(`ØªÙ… Ø¹Ø±Ø¶ ${allDrivers.length} Ø³Ø§Ø¦Ù‚Ù‹Ø§`);
        })
        .catch(err => {
          console.error('Error loading all drivers:', err);
          showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©', 'error');
        });
    }

    async function renderDriverList(drivers) {
      const list = document.getElementById('driverList');
      const showMoreContainer = document.getElementById('showMoreDrivers');
      if (showMoreContainer) showMoreContainer.remove();

      if (!drivers || drivers.length === 0) {
        list.innerHTML = '<li class="driver-item" style="padding:15px; text-align:center; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</li>';
        return;
      }

      const now = Date.now();
      const visibleDrivers = drivers.slice(0, 10);
      const hasMore = drivers.length > 10;

      // âœ… Ø¬Ù„Ø¨ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
      const unreadPromises = visibleDrivers.map(d => getUnreadCountForDriver(d.uid));
      const unreadCounts = await Promise.all(unreadPromises);

      list.innerHTML = visibleDrivers.map((d, i) => {
        const unread = unreadCounts[i] || 0;
        const timestamp = d.location?.timestamp?.toMillis?.() || 0;
        const isActive = (now - timestamp) < 20000;
        const nameToShow = d.name || '---';

        // âœ… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ØªØµØ§Ù„ + Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø±Ø³Ø§Ø¦Ù„
        const callIcon = `<i class="fas fa-phone" style="color:#1976d2; margin-left:8px;"></i>`;
        const chatIcon = unread > 0 
          ? `<span class="unread-badge">${unread}</span>`
          : `<i class="fas fa-comments" style="color:#388e3c; margin-left:6px;"></i>`;

        return `
          <li class="driver-item ${!isActive ? 'inactive' : ''}" 
              data-driver='${JSON.stringify({
                uid: d.uid,
                name: d.name || '---',
                idCard: d.idCard || '---',
                phone: d.phone || '---'
              }).replace(/'/g, "&apos;")}'>
            <span><strong>${nameToShow}</strong></span>
            <div>
              ${callIcon}
              ${chatIcon}
            </div>
          </li>
        `;
      }).join('');

      // âœ… Ø¬Ø¹Ù„ ÙƒÙ„ Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø±
      document.querySelectorAll('.driver-item').forEach(item => {
        item.onclick = (e) => {
          if (e.target.closest('.fa-phone') || e.target.closest('.unread-badge')) return;

          try {
            const driverData = JSON.parse(item.dataset.driver.replace(/&apos;/g, "'"));
            currentDriver = driverData;
            chatToggleBtn.style.display = 'flex';
            chatModal.classList.add('open');
            chatDriverInfo.textContent = `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driverData.name}`;
            loadChatHistory();
            if (item.querySelector('.unread-badge')) {
              chatToggleBtn.classList.remove('has-unread');
              unreadCount = 0;
            }
            showToast(`ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${driverData.name}`);
          } catch (e) {
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚', 'error');
          }
        };

        const phoneIcon = item.querySelector('.fa-phone');
        if (phoneIcon) {
          phoneIcon.onclick = (e) => {
            e.stopPropagation();
            const driverData = JSON.parse(item.dataset.driver.replace(/&apos;/g, "'"));
            if (driverData.phone) {
              if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${driverData.name} Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…: ${driverData.phone}ØŸ`)) {
                window.location.href = `tel:${driverData.phone}`;
              }
            } else {
              showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±', 'error');
            }
          };
        }
      });

      if (hasMore) {
        const moreDiv = document.createElement('div');
        moreDiv.id = 'showMoreDrivers';
        moreDiv.className = 'show-more-drivers';
        moreDiv.innerHTML = `
          <button onclick="showAllDrivers()">
            <i class="fas fa-list"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (${drivers.length})
          </button>
        `;
        list.parentNode.appendChild(moreDiv);
      }
    }

    // âœ… Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    function addUserToMap(user) {
      if (!map || !user.location?.lat) return;

      const timestamp = user.location.timestamp?.toMillis?.() || 0;
      const isActive = (Date.now() - timestamp) < 20000;
      const isDriver = user.role === 'driver';

      if (!isActive) {
        removeDriverFromMap(user.uid);
        return;
      }

      if (driverMarkers.has(user.uid)) {
        const marker = driverMarkers.get(user.uid);
        marker.setLatLng([user.location.lat, user.location.lng]);
        return;
      }

      // âœ… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
      const iconColor = isDriver ? '#4caf50' : '#2196f3';
      const iconHTML = isDriver ? 'ğŸš•' : 'ğŸ‘¤';

      const userIcon = L.divIcon({
        html: `
          <div style="
            width: 32px; height: 32px;
            background: ${iconColor};
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 4px ${iconColor}40;
            display: flex; align-items: center; justify-content: center;
          ">
            <span style="color:white; font-size:14px; font-weight:bold;">${iconHTML}</span>
          </div>
        `,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });

      const marker = L.marker([user.location.lat, user.location.lng], { icon: userIcon })
        .addTo(map);

      // âœ… popup Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
      marker.on('click', () => {
        let popupContent;
        
        if (isDriver) {
          const maskedId = user.idCard?.length > 5 
            ? user.idCard.substring(0,3) + '***' + user.idCard.slice(-2) 
            : user.idCard || '---';
          
          const dist = userLatLng ? calculateDistance(
            userLatLng.lat, userLatLng.lng,
            user.location.lat, user.location.lng
          ) : 0;
          
          popupContent = `
            <div style="font-family:'Segoe UI'; padding:12px; min-width:240px;">
              <h4 style="color:#075e54; margin:0 0 8px;">ğŸš– Ø³Ø§Ø¦Ù‚: <strong>${user.name || '---'}</strong></h4>
              <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin:8px 0; font-size:14px;">
                <p><strong>ğŸªª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> ${maskedId}</p>
                <p><strong>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${dist.toFixed(1)} ÙƒÙ…</p>
                <p><strong>â±ï¸ Ø§Ù„ÙˆØµÙˆÙ„:</strong> ${calculateETA(dist)} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                <p style="text-align:center; margin:10px 0 0;">
                  <span style="background:#e8f5e9; color:#2e7d32; padding:4px 12px; border-radius:20px;">
                    ğŸŸ¢ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†
                  </span>
                </p>
              </div>
              <button onclick="startChatWith('${user.uid}')" 
                      style="background:#388e3c; color:white; border:none; padding:10px; border-radius:30px; width:100%;">
                ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
              </button>
            </div>
          `;
        } else {
          popupContent = `<div style="padding:10px;">ğŸ‘¤ ${user.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>`;
        }

        marker.bindPopup(popupContent).openPopup();
      });

      driverMarkers.set(user.uid, marker);
    }

    function removeDriverFromMap(uid) {
      const marker = driverMarkers.get(uid);
      if (marker && map) {
        map.removeLayer(marker);
      }
      driverMarkers.delete(uid);
    }

    // âœ… Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù€ popup
    function startChatWith(driverUid) {
      db.collection('drivers').doc(driverUid).get().then(doc => {
        if (doc.exists) {
          const driverData = { uid: driverUid, ...doc.data() };
          currentDriver = driverData;
          chatToggleBtn.style.display = 'flex';
          chatModal.classList.add('open');
          chatDriverInfo.textContent = `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driverData.name}`;
          loadChatHistory();
          showToast(`Ø¬Ø§Ø±Ù ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${driverData.name}`);
        }
      });
    }

    function hideDriverCard() {
      document.getElementById('driverCard').style.display = 'none';
    }

    function initMap(center = [18.0852, -15.9748]) {
      if (map) return;
      
      map = L.map('map').setView(center, 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      const userIcon = L.divIcon({
        html: `<div style="width:36px;height:36px;background:#2196f3;border-radius:50%;border:3px solid white;box-shadow:0 0 0 4px rgba(33,150,243,0.4);display:flex;align-items:center;justify-content:center;"><span style="color:white;font-size:14px;">ğŸ‘¤</span></div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });

      userMarker = L.marker(center, { icon: userIcon, draggable: false }).addTo(map);
      map.on('click', hideDriverCard);
    }

    function updateLocationOnMap(lat, lng) {
      userLatLng = L.latLng(lat, lng);
      if (map && userMarker) {
        map.setView([lat, lng], 15);
        userMarker.setLatLng([lat, lng]);
      }
    }

    // --- Ø¯Ø¹Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù„Ù€ Capacitor) ---
    async function startBackgroundTracking() {
      if (typeof Capacitor === 'undefined' || Capacitor.getPlatform() === 'web') return;
      console.log('âœ… Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙ„ÙŠÙ');
    }

    async function setupPushNotifications() {
      if (typeof Capacitor === 'undefined' || Capacitor.getPlatform() === 'web') return;
      console.log('âœ… Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙ„ÙŠÙ');
    }

    // --- Firebase Auth State ---
    auth.onAuthStateChanged(async user => {
      const authSection = document.getElementById('authSection');
      const driverProfileSection = document.getElementById('driverProfileSection');
      const menuToggle = document.getElementById('menuToggle');

      if (user) {
        authSection.style.display = 'none';
        driverProfileSection.style.display = 'block';
        
        const driverDoc = await db.collection('drivers').doc(user.uid).get();
        const data = driverDoc.data();
        const nameToShow = data?.name || user.email.split('@')[0];
        const role = data?.role || 'user';

        document.getElementById('userName').textContent = nameToShow;
        localStorage.setItem('driverName', nameToShow);
        localStorage.setItem('userRole', role);
        localStorage.setItem('lastUid', user.uid);
        
        // âœ… Ø¹Ø±Ø¶ Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        document.getElementById('profileIdCardGroup').style.display = role === 'driver' ? 'block' : 'none';
        document.getElementById('profilePhoneGroup').style.display = role === 'driver' ? 'block' : 'none';
        
        if (role === 'driver') {
          document.getElementById('startTrackingBtn').style.display = 'block';
          document.getElementById('saveProfileBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚';
        } else {
          document.getElementById('startTrackingBtn').style.display = 'none';
          document.getElementById('saveProfileBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ';
        }

        // âœ… Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·Ù‹Ø§
        await db.collection('drivers').doc(user.uid).update({
          isActive: true,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });

        // âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)
        if (role === 'driver' && navigator.geolocation && !trackingInterval) {
          const updateLocation = async () => {
            try {
              const pos = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 5000
                });
              });

              const { latitude, longitude } = pos.coords;
              const timestamp = firebase.firestore.FieldValue.serverTimestamp();

              await db.collection('drivers').doc(user.uid).update({
                location: { lat: latitude, lng: longitude, timestamp },
                isActive: true,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
              });

              if (map) {
                removeDriverFromMap(user.uid);
                const fakeDriverDoc = {
                  uid: user.uid,
                  name: nameToShow,
                  idCard: data?.idCard || '---',
                  phone: data?.phone || '---',
                  role: 'driver',
                  location: { lat: latitude, lng: longitude, timestamp: { toMillis: () => Date.now() } }
                };
                addUserToMap(fakeDriverDoc);
              }
            } catch (err) {
              console.warn('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:', err);
            }
          };

          await updateLocation();
          trackingInterval = setInterval(updateLocation, 10000);
        }

        startBackgroundTracking();
        setupPushNotifications();

        if (data) {
          document.getElementById('profileName').value = data.name || '';
          document.getElementById('profileIdCard').value = data.idCard || '';
          document.getElementById('profilePhone').value = data.phone || '';
        }

      } else {
        authSection.style.display = 'block';
        driverProfileSection.style.display = 'none';
        localStorage.removeItem('driverName');
        localStorage.removeItem('userRole');
        
        const uid = localStorage.getItem('lastUid');
        if (uid) {
          db.collection('drivers').doc(uid).update({
            isActive: false
          }).then(() => {
            removeDriverFromMap(uid);
            localStorage.removeItem('lastUid');
          });
        }
        
        if (trackingInterval) {
          clearInterval(trackingInterval);
          trackingInterval = null;
        }
      }
    });

    // --- DOM Elements ---
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const registerModal = document.getElementById('registerModal');
    const chatModal = document.getElementById('chatModal');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const chatDriverInfo = document.getElementById('chatDriverInfo');

    menuToggle.onclick = () => {
      if (sidebar.classList.toggle('open')) {
        overlay.classList.add('active');
      } else {
        overlay.classList.remove('active');
      }
    };

    overlay.onclick = () => {
      sidebar.classList.remove('open');
      overlay.classList.remove('active');
      registerModal.classList.remove('open');
    };

    // âœ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    document.getElementById('registerBtn').onclick = () => {
      registerModal.classList.add('open');
      overlay.classList.add('active');
    };

    // âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('closeRegisterModal').onclick = () => {
      registerModal.classList.remove('open');
      overlay.classList.remove('active');
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
      document.getElementById('tabUser').classList.add('active');
      document.getElementById('tabDriver').classList.remove('active');
      document.getElementById('regIdCardGroup').style.display = 'none';
      document.getElementById('regPhoneGroup').style.display = 'none';
      document.getElementById('termsGroup').style.display = 'none';
      document.getElementById('termsCheck').checked = false;
      document.getElementById('submitRegister').disabled = false;
    };

    // --- âœ… Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Ø¬Ø¯ÙŠØ¯) ---
    document.addEventListener('DOMContentLoaded', () => {
      const tabUser = document.getElementById('tabUser');
      const tabDriver = document.getElementById('tabDriver');
      const regIdCardGroup = document.getElementById('regIdCardGroup');
      const regPhoneGroup = document.getElementById('regPhoneGroup');
      const termsGroup = document.getElementById('termsGroup');
      const termsCheck = document.getElementById('termsCheck');
      const submitRegister = document.getElementById('submitRegister');

      // âœ… ØªÙØ¹ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
      tabUser.classList.add('active');

      // âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø²Ø¨ÙˆÙ†"
      tabUser.onclick = () => {
        tabUser.classList.add('active');
        tabDriver.classList.remove('active');
        regIdCardGroup.style.display = 'none';
        regPhoneGroup.style.display = 'none';
        termsGroup.style.display = 'none';
        submitRegister.disabled = false;
      };

      // âœ… Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø³Ø§Ø¦Ù‚"
      tabDriver.onclick = () => {
        tabUser.classList.remove('active');
        tabDriver.classList.add('active');
        regIdCardGroup.style.display = 'block';
        regPhoneGroup.style.display = 'block';
        termsGroup.style.display = 'block';
        submitRegister.disabled = true;
      };

      // âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
      if (termsCheck) {
        termsCheck.onchange = () => {
          submitRegister.disabled = !termsCheck.checked;
        };
      }

      // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      if (submitRegister) {
        submitRegister.onclick = async () => {
          const isDriver = tabDriver.classList.contains('active');
          const name = document.getElementById('regName').value.trim();
          const email = document.getElementById('regEmail').value.trim();
          const password = document.getElementById('regPassword').value;

          if (!name || !email || !password) {
            return showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
          }

          try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await db.collection('drivers').doc(userCredential.user.uid).set({
              uid: userCredential.user.uid,
              name,
              email,
              role: isDriver ? 'driver' : 'user',
              isActive: false,
              location: null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              ...(isDriver ? {
                idCard: document.getElementById('regIdCard').value.trim(),
                phone: document.getElementById('regPhone').value.trim()
              } : {})
            });
            
            localStorage.setItem('driverName', name);
            showToast(`ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ùƒ${isDriver ? 'Ø³Ø§Ø¦Ù‚' : 'Ø²Ø¨ÙˆÙ†'} Ø¨Ù†Ø¬Ø§Ø­!`);
            registerModal.classList.remove('open');
            overlay.classList.remove('active');
          } catch (err) {
            let msg = 'Ø­Ø¯Ø« Ø®Ø·Ø£';
            if (err.code === 'auth/email-already-in-use') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§';
            showToast(msg, 'error');
          }
        };
      }
    });

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) {
        const authSection = document.getElementById('authSection');
        let errorDiv = authSection.querySelector('.alert-error');
        if (!errorDiv) {
          errorDiv = document.createElement('div');
          errorDiv.className = 'alert alert-error';
          authSection.insertBefore(errorDiv, authSection.firstChild);
        }
        errorDiv.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        setTimeout(() => errorDiv.remove(), 3000);
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        let msg = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        if (err.code === 'auth/user-not-found') msg = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯';
        else if (err.code === 'auth/invalid-credential') msg = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';

        const authSection = document.getElementById('authSection');
        let errorDiv = authSection.querySelector('.alert-error');
        if (!errorDiv) {
          errorDiv = document.createElement('div');
          errorDiv.className = 'alert alert-error';
          authSection.insertBefore(errorDiv, authSection.firstChild);
        }
        errorDiv.textContent = msg;
        setTimeout(() => errorDiv.remove(), 4000);
      }
    };

    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('logoutBtn').onclick = async () => {
      const user = auth.currentUser;
      if (user) {
        localStorage.setItem('lastUid', user.uid);
        await db.collection('drivers').doc(user.uid).update({
          isActive: false
        });
        removeDriverFromMap(user.uid);
      }
      
      if (trackingInterval) {
        clearInterval(trackingInterval);
        trackingInterval = null;
      }
      
      auth.signOut();
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
    };

    // âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    document.getElementById('saveProfileBtn').onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const name = document.getElementById('profileName').value.trim();
      const role = localStorage.getItem('userRole') || 'user';

      if (!name) return showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…', 'error');

      try {
        const updateData = { name };
        if (role === 'driver') {
          const idCard = document.getElementById('profileIdCard').value.trim();
          const phone = document.getElementById('profilePhone').value.trim();
          if (!idCard || !phone) return showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚', 'error');
          updateData.idCard = idCard;
          updateData.phone = phone;
        }

        await db.collection('drivers').doc(user.uid).update({
          ...updateData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        localStorage.setItem('driverName', name);
        document.getElementById('userName').textContent = name;
        showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error');
      }
    };

    // âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙ‚Ø·)
    document.getElementById('startTrackingBtn').onclick = async () => {
      const user = auth.currentUser;
      if (!user || localStorage.getItem('userRole') !== 'driver') return;

      if (navigator.geolocation) {
        if (trackingInterval) clearInterval(trackingInterval);

        const updateLocation = async () => {
          try {
            const pos = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000
              });
            });

            const { latitude, longitude } = pos.coords;
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            await db.collection('drivers').doc(user.uid).update({
              location: { lat: latitude, lng: longitude, timestamp },
              isActive: true,
              lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });

            if (map) {
              removeDriverFromMap(user.uid);
              const driverDoc = await db.collection('drivers').doc(user.uid).get();
              if (driverDoc.exists) {
                addUserToMap({ uid: user.uid, ...driverDoc.data() });
              }
            }
          } catch (err) {
            console.warn('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:', err);
          }
        };

        await updateLocation();
        trackingInterval = setInterval(updateLocation, 10000);

        document.getElementById('startTrackingBtn').textContent = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«';
        document.getElementById('startTrackingBtn').onclick = () => {
          if (trackingInterval) clearInterval(trackingInterval);
          trackingInterval = null;
          db.collection('drivers').doc(user.uid).update({ isActive: false });
          removeDriverFromMap(user.uid);
          document.getElementById('startTrackingBtn').textContent = 'ğŸ“ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';
          showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹');
        };
      }
    };

    // âœ… Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠ
    document.getElementById('requestBtn').onclick = async () => {
      const user = auth.currentUser;
      if (!user) {
        // ÙØªØ­ Ø§Ù„Ø´Ø±ÙŠØ· ÙˆØ·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('overlay').classList.add('active');
        let guideDiv = document.querySelector('.login-guide');
        if (!guideDiv) {
          guideDiv = document.createElement('div');
          guideDiv.className = 'alert alert-success login-guide';
          guideDiv.style.cssText = 'margin-top:10px; font-size:14px;';
          guideDiv.innerHTML = 'ğŸ”” <strong>Ù„Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠ:</strong> Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ù‹Ø§';
          document.getElementById('authSection').prepend(guideDiv);
        }
        return;
      }

      if (!userLatLng) {
        return showToast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ', 'error');
      }

      try {
        const driversSnapshot = await db.collection('drivers')
          .where('role', '==', 'driver')
          .where('isActive', '==', true)
          .get();

        if (driversSnapshot.empty) {
          document.getElementById('driverCard').style.display = 'none';
          showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹', 'error');
          return;
        }

        let closestDriver = null;
        let minDistance = Infinity;
        let closestMarker = null;

        const driversData = [];
        driversSnapshot.forEach(doc => {
          const d = doc.data();
          if (d.location && d.location.lat) {
            const dist = calculateDistance(
              userLatLng.lat, userLatLng.lng,
              d.location.lat, d.location.lng
            );
            driversData.push({ ...d, uid: doc.id, distance: dist });
            if (dist < minDistance) {
              minDistance = dist;
              closestDriver = { ...d, uid: doc.id, distance: dist };
              closestMarker = driverMarkers.get(doc.id);
            }
          }
        });

        if (!closestDriver) {
          document.getElementById('driverCard').style.display = 'none';
          return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªÙˆÙØ±Ø©', 'error');
        }

        document.getElementById('driverNameShow').textContent = closestDriver.name || '---';
        document.getElementById('driverIdCardShow').textContent = closestDriver.idCard || '---';
        document.getElementById('driverPhoneShow').textContent = closestDriver.phone || '---';
        document.getElementById('distanceText').textContent = `${minDistance.toFixed(1)} ÙƒÙ…`;
        document.getElementById('etaText').textContent = calculateETA(minDistance);

        document.getElementById('driverCard').style.display = 'block';
        currentDriver = closestDriver;
        chatToggleBtn.style.display = 'flex';

        if (closestMarker && map) {
          map.setView(closestMarker.getLatLng(), 16);
          setTimeout(() => closestMarker.openPopup(), 300);
        } else if (closestDriver.location && map) {
          map.setView([closestDriver.location.lat, closestDriver.location.lng], 16);
        }

        showToast(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø¨ÙØ¹Ø¯ ${minDistance.toFixed(1)} ÙƒÙ…`);

      } catch (err) {
        console.error('Error requesting taxi:', err);
        document.getElementById('driverCard').style.display = 'none';
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚', 'error');
      }
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessageToUI(sender, text, timestamp = new Date()) {
      const isSent = (sender === 'me');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      msgDiv.innerHTML = `
        ${text}
        <div class="message-time">${timestamp.toLocaleTimeString('ar-MA', { hour: '2-digit', minute: '2-digit' })}</div>
      `;
      chatMessages.appendChild(msgDiv);
      scrollToBottom();
    }

    function addTypingIndicator() {
      if (document.querySelector('.typing-indicator')) return;
      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator';
      indicator.innerHTML = 'Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠÙƒØªØ¨ <span>.</span><span>.</span><span>.</span>';
      chatMessages.appendChild(indicator);
      scrollToBottom();
    }

    function removeTypingIndicator() {
      const indicator = document.querySelector('.typing-indicator');
      if (indicator) indicator.remove();
    }

    chatToggleBtn.onclick = () => {
      if (chatModal.classList.contains('open')) {
        chatModal.classList.remove('open');
      } else {
        if (!currentDriver) return showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©', 'error');
        chatModal.classList.add('open');
        chatDriverInfo.textContent = `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${currentDriver.name} (${currentDriver.isActive ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·'})`;
        loadChatHistory();
        if (unreadCount > 0) {
          unreadCount = 0;
          chatToggleBtn.classList.remove('has-unread');
        }
      }
    };

    document.getElementById('closeChat').onclick = () => {
      chatModal.classList.remove('open');
    };

    sendMessageBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text || !currentDriver) return;

      try {
        const user = auth.currentUser;
        if (!user) throw new Error('ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');

        const uids = [user.uid, currentDriver.uid].sort();
        const roomId = uids.join('_');

        const senderName = localStorage.getItem('driverName') || 'Ø£Ù†Ø§';

        const message = {
          text,
          sender: user.uid,
          senderName: senderName,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false
        };

        await db.collection('chats').doc(roomId).collection('messages').add(message);
        messageInput.value = '';
        removeTypingIndicator();

      } catch (err) {
        showToast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
      }
    };

    messageInput.onkeypress = (e) => {
      if (e.key === 'Enter') sendMessageBtn.click();
    };

    messageInput.oninput = () => {
      if (!currentDriver) return;
      const user = auth.currentUser;
      if (!user) return;

      const uids = [user.uid, currentDriver.uid].sort();
      const roomId = uids.join('_');

      if (!isTyping) {
        isTyping = true;
        db.collection('chats').doc(roomId).set({
          typing: user.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        setTimeout(() => {
          isTyping = false;
          db.collection('chats').doc(roomId).set({ typing: null }, { merge: true });
        }, 3000);
      }
    };

    async function loadChatHistory() {
      if (chatUnsubscribe) chatUnsubscribe();

      const user = auth.currentUser;
      if (!user || !currentDriver) return;

      const uids = [user.uid, currentDriver.uid].sort();
      const roomId = uids.join('_');
      currentChatRoom = roomId;

      const messagesRef = db.collection('chats').doc(roomId).collection('messages').orderBy('timestamp', 'asc');
      
      chatUnsubscribe = messagesRef.onSnapshot(snapshot => {
        if (snapshot.docChanges().length === 0 && chatMessages.children.length > 0) return;

        chatMessages.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const isSent = (msg.sender === user.uid);
          const time = msg.timestamp?.toDate?.() || new Date();
          
          if (!isSent && !msg.read) {
            db.collection('chats').doc(roomId).collection('messages').doc(doc.id).update({ read: true });
          }

          addMessageToUI(isSent ? 'me' : 'driver', msg.text, time);
        });

        setTimeout(scrollToBottom, 100);
      });

      db.collection('chats').doc(roomId).onSnapshot(doc => {
        if (doc.exists && doc.data().typing && doc.data().typing !== user.uid) {
          addTypingIndicator();
        } else {
          removeTypingIndicator();
        }
      });
    }

    // --- Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ---
    function startListeningToDrivers() {
      const driversRef = db.collection('drivers')
        .where('role', '==', 'driver')
        .where('isActive', '==', true);
      
      driversRef.onSnapshot(snapshot => {
        const activeDrivers = [];
        snapshot.docChanges().forEach(change => {
          const user = { uid: change.doc.id, ...change.doc.data() };

          if (change.type === 'added' || change.type === 'modified') {
            if (user.location?.lat) {
              addUserToMap(user);
            }
            activeDrivers.push(user);
          } else if (change.type === 'removed') {
            removeDriverFromMap(user.uid);
          }

          if (currentDriver && currentDriver.uid === user.uid) {
            currentDriver = user;
            if (chatModal.classList.contains('open')) {
              chatDriverInfo.textContent = `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${user.name} (${user.isActive ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·'})`;
            }
          }
        });

        activeDrivers.sort((a, b) => 
          (b.location?.timestamp?.toMillis?.() || 0) - (a.location?.timestamp?.toMillis?.() || 0)
        );
        
        const user = auth.currentUser;
        if (user) {
          renderDriverList(activeDrivers);
        }
        
        lastRenderTime = Date.now();
      });
    }

    // --- Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ---
    document.getElementById('allowBtn').onclick = () => {
      if (!navigator.geolocation) {
        showToast('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ', 'error');
        return;
      }

      document.getElementById('allowBtn').disabled = true;
      document.getElementById('allowBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

      showToast('Ù†Ù†ØªØ¸Ø± Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­â€¦', 'success');

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;

          document.getElementById('permissionScreen').style.display = 'none';
          document.getElementById('mapContainer').style.display = 'block';
          document.getElementById('controlBtns').style.display = 'block';

          if (!map) {
            initMap([latitude, longitude]);
          } else {
            map.setView([latitude, longitude], 15);
          }

          updateLocationOnMap(latitude, longitude);
          startListeningToDrivers();

          showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø©! Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ù„Ø­Ø¸Ø§Øª.', 'success');
          document.getElementById('allowBtn').disabled = false;
        },
        (error) => {
          console.error('Geolocation denied/error:', error);
          document.getElementById('allowBtn').disabled = false;
          document.getElementById('allowBtn').innerHTML = '<span class="emoji">ğŸ§­</span> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†';

          let msg = 'ÙŠØ±Ø¬Ù‰ ØªÙ…ÙƒÙŠÙ† Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§.';
          if (error.code === 1) {
            msg = 'âŒ Ø±ÙØ¶Øª Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ ğŸ”’ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆÙØ¹Ù‘Ù„ "Ø§Ù„Ù…ÙˆÙ‚Ø¹"';
          }
          showToast(msg, 'error');

          const instructions = document.createElement('div');
          instructions.innerHTML = `
            <div style="margin-top:20px; background:#fff3cd; border-right:4px solid #ffc107; padding:12px; border-radius:0 8px 8px 0;">
              <strong>ÙƒÙŠÙ ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ</strong><br>
              â€¢ ÙƒØ±ÙˆÙ…: Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ <strong>Ø§Ù„Ù‚ÙÙ„ ğŸ”’</strong> â† <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹</strong> â† <strong>Ø§Ù„Ø³Ù…Ø§Ø­</strong><br>
              â€¢ ÙØ§ÙŠØ±ÙÙˆÙƒØ³: <strong>â‹® â† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â† Ø§Ù„Ø®ØµÙˆØµÙŠØ© â† Ø§Ù„Ù…ÙˆÙ‚Ø¹</strong>
            </div>
          `;
          const screen = document.getElementById('permissionScreen');
          if (!screen.querySelector('div[style*="fff3cd"]')) {
            screen.appendChild(instructions);
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    };

    // âœ… ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', () => {
      if (trackingInterval) clearInterval(trackingInterval);
      if (chatUnsubscribe) chatUnsubscribe();
      driverMarkers.forEach(marker => {
        if (map) map.removeLayer(marker);
      });
      driverMarkers.clear();
    });
  </script>
</body>
</html>
